<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Manage Users</title>
  <link rel="stylesheet" href="admin-user.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
</head>
<body>

  <div class="admin-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand"><h2>ğŸ½ FoodLoft Admin</h2></div>
      <nav>
        <a href="admin.html">ğŸ“Š Dashboard</a>
        <a href="admin-products.html">ğŸ“¦ Products</a>
        <a href="admin-user.html" class="active">ğŸ‘¤ Users</a>
        <a href="admin-order-history.html">ğŸ“œ Order History</a>
        <a href="admin-pending-orders.html">â³ Pending Orders</a>
        <a href="admin-sales.html">ğŸ’° Sales</a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="top-header">
        <span class="logged-in">âœ… Admin Logged In</span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>

      <header>
        <h1>Manage Users</h1>
        <p>Add, edit, and remove users from the system.</p>
      </header>

      <!-- Add User Form -->
      <section class="form-section">
        <h2>Add New User</h2>
        <form id="addUserForm">
          <input type="text" id="fullName" placeholder="Full Name" required />
          <input type="email" id="email" placeholder="Email" required />
          <input type="password" id="password" placeholder="Password" required />
          <input type="text" id="address" placeholder="Address" />
          <input type="text" id="contactNumber" placeholder="Contact Number" />
          <select id="role" required>
            <option value="" disabled selected>Select Role</option>
            <option value="admin">Admin</option>
            <option value="customer">Customer</option>
          </select>
          <button type="submit">â• Add User</button>
        </form>
      </section>

      <!-- Users Table -->
      <section class="table-section">
        <h2>Existing Users</h2>
        <table>
          <thead>
            <tr>
              <th>User ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="userTableBody"></tbody>
        </table>
      </section>
    </main>
  </div>

  <script>
    const API_URL = "http://localhost:3000/api/users";

    function logout() {
      alert("Logging out...");
      window.location.href = "login.html";
    }

    // Render users in table
    function renderUsers(users) {
      const tbody = document.getElementById("userTableBody");
      tbody.innerHTML = "";

      users.forEach(user => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${user.user_id}</td>
          <td contenteditable="false" class="editable full_name">${user.full_name}</td>
          <td contenteditable="false" class="editable email">${user.email}</td>
          <td contenteditable="false" class="editable role">${user.role}</td>
          <td>
            <button class="edit-btn" onclick="editUser(this, ${user.user_id})">âœï¸ Edit</button>
            <button class="delete-btn" onclick="deleteUser(${user.user_id})">ğŸ—‘ï¸ Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Load users from backend
    async function loadUsers() {
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error("Failed to fetch users");
        const users = await res.json();
        renderUsers(users);
      } catch (err) {
        alert("Error loading users from backend.");
        console.error(err);
      }
    }

    // Add User handler
    document.getElementById("addUserForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const full_name = document.getElementById("fullName").value.trim();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const address = document.getElementById("address").value.trim();
      const contact_number = document.getElementById("contactNumber").value.trim();
      const role = document.getElementById("role").value;

      if (!full_name || !email || !password || !role) {
        alert("Please fill in all required fields.");
        return;
      }

      const userData = { full_name, email, password, address, contact_number, role };

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(userData),
        });

        const data = await res.json();

        if (res.ok) {
          alert("User added successfully!");
          e.target.reset();
          loadUsers();
        } else {
          alert("Error adding user: " + (data.error || "Unknown error"));
        }
      } catch (err) {
        alert("Failed to add user.");
        console.error(err);
      }
    });

    // Edit User inline (excluding password)
    function editUser(btn, userId) {
      const row = btn.closest("tr");
      const fullNameCell = row.querySelector(".full_name");
      const emailCell = row.querySelector(".email");
      const roleCell = row.querySelector(".role");

      if (btn.textContent === "âœï¸ Edit") {
        fullNameCell.contentEditable = "true";
        emailCell.contentEditable = "true";
        roleCell.contentEditable = "true";
        btn.textContent = "ğŸ’¾ Save";
      } else {
        const updatedUser = {
          full_name: fullNameCell.innerText.trim(),
          email: emailCell.innerText.trim(),
          role: roleCell.innerText.trim()
        };

        fetch(`${API_URL}/${userId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updatedUser),
        })
        .then(res => {
          if (!res.ok) throw new Error("Failed to update user");
          return res.json();
        })
        .then(() => {
          fullNameCell.contentEditable = "false";
          emailCell.contentEditable = "false";
          roleCell.contentEditable = "false";
          btn.textContent = "âœï¸ Edit";
          loadUsers();
        })
        .catch(err => {
          alert("Error updating user.");
          console.error(err);
        });
      }
    }

    // Delete User handler
    async function deleteUser(userId) {
      if (!confirm("Are you sure you want to delete this user?")) return;

      try {
        const res = await fetch(`${API_URL}/${userId}`, { method: "DELETE" });
        if (res.ok) {
          alert("User deleted successfully.");
          loadUsers();
        } else {
          const data = await res.json();
          alert("Error deleting user: " + (data.error || res.statusText));
        }
      } catch (err) {
        alert("Failed to delete user.");
        console.error(err);
      }
    }

    // Load users on page load
    loadUsers();
  </script>

</body>
</html>
