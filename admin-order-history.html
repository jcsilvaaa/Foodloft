<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Order History</title>
  <link rel="stylesheet" href="admin-order-history.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

  <div class="admin-container">

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <h2>üçΩ FoodLoft Admin</h2>
      </div>
      <nav>
        <a href="admin.html">üìä Dashboard</a>
        <a href="admin-products.html">üì¶ Products</a>
        <a href="admin-user.html">üë§ Users</a>
        <a href="admin-order-history.html" class="active">üìú Order History</a>
        <a href="admin-sales.html">üí∞ Sales</a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">

      <!-- Top Header -->
      <div class="top-header">
        <span class="logged-in">‚úÖ Admin Logged In</span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>

      <header>
        <h1>Order History</h1>
        <p>View all completed orders from the system.</p>
        <div class="header-actions">
          <button class="add-order-btn" onclick="showAddOrderModal()">‚ûï Add New Order</button>
        </div>
      </header>

      <!-- Orders Table -->
      <section class="order-history-section">
        <table>
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Items</th>
              <th>Total Price</th>
              <th>Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="ordersTableBody">
            <tr>
              <td colspan="7" class="loading">Loading orders...</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Add Order Modal -->
      <div id="addOrderModal" class="modal" style="display: none;">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Add New Order</h2>
            <span class="close" onclick="hideAddOrderModal()">&times;</span>
          </div>
          <form id="addOrderForm">
            <div class="form-group">
              <label for="customerId">Customer:</label>
              <select id="customerId" required>
                <option value="">Select Customer</option>
              </select>
            </div>
            <div class="form-group">
              <label for="customerName">Customer Name:</label>
              <input type="text" id="customerName" required placeholder="Enter customer full name">
            </div>
            <div class="form-group">
              <label for="deliveryAddress">Delivery Address:</label>
              <textarea id="deliveryAddress" required></textarea>
            </div>
            <div class="form-group">
              <label>Items:</label>
              <div id="orderItems">
                <div class="item-row">
                  <select class="food-select" required>
                    <option value="">Select Food</option>
                  </select>
                  <input type="number" class="quantity-input" placeholder="Qty" min="1" value="1" required>
                  <button type="button" onclick="removeItem(this)">Remove</button>
                </div>
              </div>
              <button type="button" onclick="addItem()">Add Item</button>
            </div>
            <div class="form-group">
              <label>Total Price: ‚Ç±<span id="totalPrice">0.00</span></label>
            </div>
            <div class="modal-actions">
              <button type="button" onclick="hideAddOrderModal()">Cancel</button>
              <button type="submit">Create Order</button>
            </div>
          </form>
        </div>
      </div>

    </main>
  </div>

  <script>
    let users = [];
    let foods = [];
    
    // Load data when page loads
    window.addEventListener('DOMContentLoaded', function() {
      loadOrders();
      loadUsers();
      loadFoods();
    });
    
    function logout() {
      alert("Logging out...");
      window.location.href = "login.html";
    }
    
    async function loadOrders() {
      try {
        const response = await fetch('/api/orders');
        const orders = await response.json();
        
        const tbody = document.getElementById('ordersTableBody');
        
        if (orders.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7">No orders found</td></tr>';
          return;
        }
        
        tbody.innerHTML = orders.map(order => `
          <tr>
            <td>#${order.order_id}</td>
            <td>${order.customer_name || 'Unknown Customer'}</td>
            <td>${order.items || 'No items'}</td>
            <td>‚Ç±${parseFloat(order.total_price || 0).toFixed(2)}</td>
            <td>${new Date(order.order_date).toLocaleDateString()}</td>
            <td class="status ${order.status}">
              <select class="status-dropdown" data-order-id="${order.order_id}" data-original-status="${order.status}" onchange="updateOrderStatus(this)">
                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Ready</option>
                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Completed</option>
                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
              </select>
            </td>
            <td>
              <button class="view-btn" onclick="viewOrderDetails(${order.order_id})">View Details</button>
            </td>
          </tr>
        `).join('');
        
      } catch (error) {
        console.error('Error loading orders:', error);
        document.getElementById('ordersTableBody').innerHTML = 
          '<tr><td colspan="7">Error loading orders</td></tr>';
      }
    }
    
    async function loadUsers() {
      try {
        const response = await fetch('/api/users');
        users = await response.json();
        
        const select = document.getElementById('customerId');
        select.innerHTML = '<option value="">Select Customer</option>' +
          users.map(user => `<option value="${user.user_id}">${user.full_name}</option>`).join('');
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }
    
    async function loadFoods() {
      try {
        const response = await fetch('/api/food');
        foods = await response.json();
        updateFoodSelects();
      } catch (error) {
        console.error('Error loading foods:', error);
      }
    }
    
    function updateFoodSelects() {
      const selects = document.querySelectorAll('.food-select');
      selects.forEach(select => {
        select.innerHTML = '<option value="">Select Food</option>' +
          foods.map(food => `<option value="${food.food_id}" data-price="${food.price}">${food.name} - ‚Ç±${food.price}</option>`).join('');
        
        select.addEventListener('change', calculateTotal);
      });
    }
    
    function showAddOrderModal() {
      document.getElementById('addOrderModal').style.display = 'block';
      // Ensure foods are loaded when modal opens
      if (!foods || foods.length === 0) {
        loadFoods();
      } else {
        updateFoodSelects();
      }
    }
    
    function hideAddOrderModal() {
      document.getElementById('addOrderModal').style.display = 'none';
      document.getElementById('addOrderForm').reset();
      // Reset items to single row
      document.getElementById('orderItems').innerHTML = `
        <div class="item-row">
          <select class="food-select" required>
            <option value="">Select Food</option>
          </select>
          <input type="number" class="quantity-input" placeholder="Qty" min="1" value="1" required>
          <button type="button" onclick="removeItem(this)">Remove</button>
        </div>
      `;
      updateFoodSelects();
      calculateTotal();
    }
    
    function addItem() {
      const itemsContainer = document.getElementById('orderItems');
      const newRow = document.createElement('div');
      newRow.className = 'item-row';
      newRow.innerHTML = `
        <select class="food-select" required>
          <option value="">Select Food</option>
        </select>
        <input type="number" class="quantity-input" placeholder="Qty" min="1" value="1" required>
        <button type="button" onclick="removeItem(this)">Remove</button>
      `;
      itemsContainer.appendChild(newRow);
      updateFoodSelects();
    }
    
    function removeItem(button) {
      const itemsContainer = document.getElementById('orderItems');
      if (itemsContainer.children.length > 1) {
        button.parentElement.remove();
        calculateTotal();
      }
    }
    
    function calculateTotal() {
      let total = 0;
      const itemRows = document.querySelectorAll('.item-row');
      
      itemRows.forEach(row => {
        const select = row.querySelector('.food-select');
        const quantityInput = row.querySelector('.quantity-input');
        
        if (select.value && quantityInput.value) {
          const price = parseFloat(select.options[select.selectedIndex].dataset.price || 0);
          const quantity = parseInt(quantityInput.value || 0);
          total += price * quantity;
        }
      });
      
      document.getElementById('totalPrice').textContent = total.toFixed(2);
    }
    
    // Add event listeners for quantity inputs
    document.addEventListener('input', function(e) {
      if (e.target.classList.contains('quantity-input')) {
        calculateTotal();
      }
    });
    
    document.getElementById('addOrderForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const customerId = document.getElementById('customerId').value;
      const customerName = document.getElementById('customerName').value;
      const deliveryAddress = document.getElementById('deliveryAddress').value;
      const itemRows = document.querySelectorAll('.item-row');
      
      const items = [];
      let totalPrice = 0;
      
      for (const row of itemRows) {
        const select = row.querySelector('.food-select');
        const quantityInput = row.querySelector('.quantity-input');
        
        if (select.value && quantityInput.value && select.value !== '') {
          const foodId = parseInt(select.value);
          const price = parseFloat(select.options[select.selectedIndex].dataset.price);
          const quantity = parseInt(quantityInput.value);
          
          // Validate that we have valid values
          if (!isNaN(foodId) && !isNaN(price) && !isNaN(quantity) && foodId > 0 && quantity > 0) {
            items.push({
              food_id: foodId,
              quantity: quantity,
              price: price
            });
            
            totalPrice += price * quantity;
          } else {
            alert('Please ensure all food items have valid selections and quantities');
            return;
          }
        }
      }
      
      if (items.length === 0) {
        alert('Please add at least one item');
        return;
      }
      
      if (!customerName) {
        alert('Please enter customer name');
        return;
      }
      
      try {
        const response = await fetch('/api/orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            user_id: parseInt(customerId) || 1, // Default to 1 if no customer selected
            items: items,
            delivery_address: deliveryAddress,
            total_price: totalPrice,
            customer_name: customerName
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('Order created successfully!');
          hideAddOrderModal();
          loadOrders(); // Refresh the orders list
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        console.error('Error creating order:', error);
        alert('Error creating order');
      }
    });
    
    // Function to update order status
    async function updateOrderStatus(selectElement) {
      const orderId = selectElement.getAttribute('data-order-id');
      const newStatus = selectElement.value;
      const originalStatus = selectElement.getAttribute('data-original-status') || selectElement.dataset.originalStatus || 'pending';
      
      // If status hasn't changed, don't make request
      if (newStatus === originalStatus) {
        return;
      }
      
      try {
        const response = await fetch(`/api/orders/${orderId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            status: newStatus
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          // Update the visual status
          const statusCell = selectElement.parentElement;
          statusCell.className = `status ${newStatus}`;
          selectElement.setAttribute('data-original-status', newStatus);
          
          // Show success message
          showStatusMessage(`Order #${orderId} status updated to ${newStatus.charAt(0).toUpperCase() + newStatus.slice(1)}`, 'success');
        } else {
          // Revert the dropdown to original status on error
          selectElement.value = originalStatus;
          showStatusMessage('Error: ' + result.error, 'error');
        }
      } catch (error) {
        console.error('Error updating order status:', error);
        selectElement.value = originalStatus;
        showStatusMessage('Error updating order status: ' + error.message, 'error');
      }
    }
    
    // Function to show status messages
    function showStatusMessage(message, type) {
      // Remove any existing status messages
      const existingMessage = document.querySelector('.status-message');
      if (existingMessage) {
        existingMessage.remove();
      }
      
      // Create new status message
      const messageDiv = document.createElement('div');
      messageDiv.className = `status-message ${type}`;
      messageDiv.textContent = message;
      
      // Insert at the top of the main content
      const mainContent = document.querySelector('.main-content');
      mainContent.insertBefore(messageDiv, mainContent.firstChild);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        messageDiv.remove();
      }, 5000);
    }
    
    // Function to view order details (placeholder)
    function viewOrderDetails(orderId) {
      alert(`View details for Order #${orderId}\n\nThis feature can be expanded to show:\n- Customer information\n- Order items breakdown\n- Delivery address\n- Payment method\n- Order timeline`);
    }
  </script>

</body>
</html>
