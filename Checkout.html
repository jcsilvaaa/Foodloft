<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FoodLoft - Checkout</title>
  <link rel="stylesheet" href="Checkout.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet" />
</head>
<body>
  <header>
    <div class="logo">
      <h1>FoodLoftPH</h1>
    </div>
    <nav>
      <ul>
        <li><a href="Homepage.html">Home</a></li>
        <li><a href="menu.html">Menu</a></li>
        <li><a href="cart.html" class="active">Cart</a></li>
        <li class="user-menu">
          <img id="userAvatar" src="user.jpg" alt="User Profile" />
          <ul class="dropdown" id="user-dropdown">
            <li><a href="#">Profile</a></li>
            <li><a href="#">Log Out</a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </header>

  <main class="checkout-container">
    <h1 class="title">Checkout</h1>
    <div class="checkout-grid">
      <section class="billing">
        <h2>Billing Details</h2>
        <form id="checkoutForm">
          <div class="form-row">
            <input type="text" name="first_name" placeholder="First Name*" required />
            <input type="text" name="last_name" placeholder="Last Name*" required />
          </div>
          <input type="text" name="company_name" placeholder="Company Name (optional)" />
          <input type="text" name="country_region" placeholder="Country / Region*" required />
          <input type="text" name="street_address" placeholder="Street Address*" required />
          <input type="text" name="city" placeholder="Town / City*" required />
          <div class="form-row">
            <input type="text" name="state" placeholder="State*" required />
            <input type="text" name="zip" placeholder="ZIP*" required />
          </div>
          <input type="tel" name="phone_number" placeholder="Phone*" required />
          <input type="email" name="email_address" placeholder="Email Address*" required />

          <h3>Additional Information</h3>
          <textarea name="additional_info" placeholder="Notes about your order (optional)"></textarea>

          <select name="payment_method" required>
            <option value="Cash on Delivery">Cash on Delivery</option>
            <option value="Credit Card">Credit Card</option>
            <option value="Gcash">Gcash</option>
            <option value="Apple Pay">Apple Pay</option>
          </select>

          <button type="submit" class="place-order">Place Order →</button>
        </form>
        <div id="message"></div>
      </section>

      <aside class="summary">
        <h2>Your Order</h2>
        <div id="order-items"></div>
        <hr>
        <p><strong>Total:</strong> ₱<span id="order-total">0.00</span></p>
      </aside>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 FoodLoft. Made with flavor and tradition.</p>
    IG: @FoodLoft &nbsp; | &nbsp; FB: FoodLoft
  </footer>

  <script>
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user || !user.user_id) {
      alert("You must be logged in to proceed to checkout.");
      window.location.href = "login.html";
    }

    const user_id = user.user_id;

    async function loadCartSummary() {
      const orderItemsContainer = document.getElementById('order-items');
      const totalDisplay = document.getElementById('order-total');
      try {
        const res = await fetch(`http://localhost:3000/cart/${user_id}`);
        const cartItems = await res.json();

        if (!Array.isArray(cartItems) || cartItems.length === 0) {
          orderItemsContainer.innerHTML = '<p>Your cart is empty.</p>';
          totalDisplay.textContent = '0.00';
          return;
        }

        let total = 0;
        orderItemsContainer.innerHTML = '';
        cartItems.forEach(item => {
          const subtotal = item.price * item.quantity;
          total += subtotal;

          const itemDiv = document.createElement('div');
          itemDiv.innerHTML = `<p>${item.name} × ${item.quantity} - ₱${subtotal.toFixed(2)}</p>`;
          orderItemsContainer.appendChild(itemDiv);
        });

        totalDisplay.textContent = total.toFixed(2);
      } catch (err) {
        console.error('Failed to load cart summary:', err);
        orderItemsContainer.innerHTML = '<p>Failed to load cart.</p>';
      }
    }

    loadCartSummary();

    document.getElementById('checkoutForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const formData = new FormData(e.target);
      const data = {};
      formData.forEach((value, key) => data[key] = value);
      data.user_id = user_id;

      try {
        const cartRes = await fetch(`http://localhost:3000/cart/${user_id}`);
        const cartItems = await cartRes.json();

        if (!Array.isArray(cartItems) || cartItems.length === 0) {
          document.getElementById('message').textContent = 'Cart is empty.';
          return;
        }

        let total_amount = 0;
        const items = cartItems.map(item => {
          const itemTotal = item.price * item.quantity;
          total_amount += itemTotal;
          return {
            food_id: item.food_id,
            quantity: item.quantity,
            price: item.price
          };
        });

        data.cartItems = items;
        data.total_amount = total_amount;

        const res = await fetch('http://localhost:3000/checkout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        const result = await res.json();
        if (!res.ok) {
          throw new Error(result.message || 'Order failed');
        }

        

        document.getElementById('message').textContent = result.message;
        alert('✅ Order placed successfully!');
        window.location.href = 'order_confirmed.html';
      } catch (err) {
        console.error(err);
        document.getElementById('message').textContent = 'Failed to place order: ' + err.message;
      }
    });
  </script>
</body>
</html>