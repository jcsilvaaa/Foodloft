<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order History - FoodLoft</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Playfair+Display:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", sans-serif;
        background-color: #fff8f0;
        color: #333;
      }

      /* Header */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #8b0000;
        padding: 20px;
        color: white;
        font-family: "Playfair Display", serif;
      }

      .logo h1 {
        font-size: 2.5rem;
        font-weight: 700;
        letter-spacing: 1px;
      }

      nav ul {
        list-style: none;
        display: flex;
        align-items: center;
      }

      nav ul li {
        margin: 0 15px;
      }

      nav ul li a {
        color: white;
        text-decoration: none;
        font-size: 1.1rem;
        font-weight: 500;
      }

      .user-menu {
        position: relative;
      }

      .user-menu img {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        object-fit: cover;
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .user-menu img:hover {
        transform: scale(1.1);
      }

      .user-menu .dropdown {
        display: none;
        position: absolute;
        right: 0;
        background-color: white;
        min-width: 150px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        border-radius: 5px;
        z-index: 10;
      }

      .user-menu:hover .dropdown {
        display: block;
      }

      .user-menu .dropdown li {
        padding: 10px;
        text-align: center;
      }

      .user-menu .dropdown li a {
        text-decoration: none;
        color: #8b0000;
        display: block;
        font-size: 1rem;
      }

      .user-menu .dropdown li a:hover {
        background-color: #f3e5d8;
      }

      /* Main Content */
      .order-history-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 20px;
      }

      .page-header {
        text-align: center;
        margin-bottom: 40px;
      }

      .page-header h1 {
        font-size: 2.5rem;
        color: #8b0000;
        font-family: "Playfair Display", serif;
        margin-bottom: 10px;
      }

      .page-header p {
        font-size: 1.2rem;
        color: #666;
      }

      /* Filter Section */
      .filter-section {
        background-color: #fff0e5;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
      }

      .filter-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .filter-group label {
        font-weight: 600;
        color: #8b0000;
      }

      .filter-group select,
      .filter-group input {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 1rem;
      }

      /* Order Cards */
      .orders-list {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .order-card {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 25px;
        transition: transform 0.3s ease;
      }

      .order-card:hover {
        transform: translateY(-2px);
      }

      .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #fce5cd;
      }

      .order-number {
        font-size: 1.3rem;
        font-weight: 600;
        color: #8b0000;
      }

      .order-date {
        color: #666;
        font-size: 1rem;
      }

      .order-status {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-delivered {
        background-color: #d4edda;
        color: #155724;
      }

      .status-cancelled {
        background-color: #f8d7da;
        color: #721c24;
      }

      .status-processing {
        background-color: #fff3cd;
        color: #856404;
      }

      /* Order Items */
      .order-items {
        margin-bottom: 20px;
      }

      .order-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .order-item:last-child {
        border-bottom: none;
      }

      .item-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .item-image {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
      }

      .item-details h4 {
        color: #333;
        margin-bottom: 5px;
      }

      .item-details p {
        color: #666;
        font-size: 0.9rem;
      }

      .item-price {
        font-weight: 600;
        color: #8b0000;
      }

      /* Order Summary */
      .order-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 15px;
        border-top: 2px solid #fce5cd;
      }

      .order-total {
        font-size: 1.3rem;
        font-weight: 700;
        color: #8b0000;
      }

      .order-actions {
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.3s ease;
      }

      .btn-primary {
        background-color: #8b0000;
        color: white;
      }

      .btn-primary:hover {
        background-color: #a60000;
      }

      .btn-secondary {
        background-color: #f8f9fa;
        color: #333;
        border: 1px solid #ccc;
      }

      .btn-secondary:hover {
        background-color: #e9ecef;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .empty-state img {
        width: 150px;
        height: 150px;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .empty-state h3 {
        font-size: 1.5rem;
        margin-bottom: 10px;
        color: #8b0000;
      }

      /* Spinner */
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 4px solid #8b0000;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Footer */
      footer {
        background-color: #8b0000;
        color: white;
        text-align: center;
        padding: 20px;
        font-size: 0.95rem;
        margin-top: 60px;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .filter-section {
          flex-direction: column;
          align-items: stretch;
        }

        .order-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .order-summary {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
        }

        .item-info {
          flex-direction: column;
          align-items: flex-start;
          text-align: left;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="logo">
        <h1><a href="Homepage.html" class="logo-link">FoodLoftPH</a></h1>
      </div>
      <nav>
        <ul>
          <li><a href="menu.html">Menu</a></li>
          <li><a href="cart.html">Cart</a></li>
          <li class="user-menu">
            <img id="userAvatar" src="user.jpg" alt="User Profile" />
            <ul class="dropdown" id="user-dropdown">
              <li id="profile-link"><a href="User.html">Profile</a></li>
              <li id="order-history-link">
                <a href="order-history.html">Order History</a>
              </li>
              <li id="login-link"><a href="login.html">Login</a></li>
              <li id="logout-link"><a href="#">Log Out</a></li>
            </ul>
          </li>
        </ul>
      </nav>
    </header>

    <div class="order-history-container">
      <div class="page-header">
        <h1>Order History</h1>
        <p>Track your delicious journey with FoodLoft</p>
      </div>

      <div class="filter-section">
        <div class="filter-group">
          <label for="status-filter">Status:</label>
          <select id="status-filter">
            <option value="all">All Orders</option>
            <option value="delivered">Delivered</option>
            <option value="processing">Processing</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="date-from">From:</label>
          <input type="date" id="date-from" />
        </div>
        <div class="filter-group">
          <label for="date-to">To:</label>
          <input type="date" id="date-to" />
        </div>
      </div>

      <div class="orders-list" id="orders-container">
        <!-- Orders will be loaded here dynamically -->
      </div>
    </div>

    <footer>
      <p>&copy; 2025 FoodLoft. Made with flavor and tradition.</p>
      IG: @FoodLoft &nbsp; | &nbsp; FB: FoodLoft
    </footer>

    <script>
      // Check login state and get user data
      const user = JSON.parse(localStorage.getItem("user"));
      const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";

      // DOM elements
      const ordersContainer = document.getElementById("orders-container");
      const statusFilter = document.getElementById("status-filter");
      const dateFrom = document.getElementById("date-from");
      const dateTo = document.getElementById("date-to");

      // Navigation elements
      const loginLink = document.getElementById("login-link");
      const logoutLink = document.getElementById("logout-link");
      const profileLink = document.getElementById("profile-link");
      const orderHistoryLink = document.getElementById("order-history-link");

      // Set navigation visibility based on login state
      if (isLoggedIn) {
        loginLink.style.display = "none";
        logoutLink.style.display = "block";
        profileLink.style.display = "block";
        orderHistoryLink.style.display = "block";
      } else {
        loginLink.style.display = "block";
        logoutLink.style.display = "none";
        profileLink.style.display = "none";
        orderHistoryLink.style.display = "none";
        window.location.href = "login.html";
      }

      // Show loading state
      function showLoading() {
        ordersContainer.innerHTML = `
          <div class="empty-state">
            <div class="spinner"></div>
            <h3>Loading your orders...</h3>
          </div>
        `;
      }

      // Show empty state
      function showEmptyState() {
        ordersContainer.innerHTML = `
          <div class="empty-state">
            <img src="empty-cart.svg" alt="No orders">
            <h3>No Orders Found</h3>
            <p>You haven't placed any orders yet. Ready to start your food journey?</p>
            <a href="menu.html" class="btn btn-primary" style="margin-top: 20px;">Browse Menu</a>
          </div>
        `;
      }

      // Show error state
      function showErrorState(message) {
        ordersContainer.innerHTML = `
          <div class="empty-state">
            <img src="error-icon.svg" alt="Error">
            <h3>Error Loading Orders</h3>
            <p>${
              message ||
              "Failed to load your order history. Please try again later."
            }</p>
            <button class="btn btn-primary" onclick="fetchOrders()" style="margin-top: 20px;">Retry</button>
          </div>
        `;
      }

      // Render orders to the page
      function renderOrders(orders) {
        if (orders.length === 0) {
          showEmptyState();
          return;
        }

        ordersContainer.innerHTML = "";

        orders.forEach((order) => {
          const orderDate = new Date(order.order_date).toLocaleDateString(
            "en-US",
            {
              year: "numeric",
              month: "long",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            }
          );

          // Convert string prices to numbers
          const totalPrice = parseFloat(order.total_price);
          const orderCard = document.createElement("div");
          orderCard.className = "order-card";
          orderCard.innerHTML = `
      <div class="order-header">
        <div>
          <div class="order-number">Order #${order.order_id}</div>
          <div class="order-date">${orderDate}</div>
        </div>
        <div class="order-status status-${order.status.toLowerCase()}">${
            order.status
          }</div>
      </div>

      <div class="order-items">
        ${order.items
          .map((item) => {
            const itemPrice = parseFloat(item.price);
            const itemTotal = itemPrice * parseInt(item.quantity);
            return `
            <div class="order-item">
              <div class="item-info">
                <img src="${item.image || "default-food.jpg"}" alt="${
              item.name
            }" class="item-image">
                <div class="item-details">
                  <h4>${item.name}</h4>
                  <p>${item.description || ""} • Qty: ${item.quantity}</p>
                </div>
              </div>
              <div class="item-price">₱${itemTotal.toFixed(2)}</div>
            </div>
          `;
          })
          .join("")}
      </div>

      <div class="order-summary">
        <div class="order-total">Total: ₱${totalPrice.toFixed(2)}</div>
        <div class="order-actions">
          ${
            order.status === "delivered" || order.status === "cancelled"
              ? `<button class="btn btn-primary" onclick="reorder(${order.order_id})">Reorder</button>`
              : ""
          }
          ${
            order.status === "processing"
              ? `<button class="btn btn-secondary" onclick="cancelOrder(${order.order_id})">Cancel Order</button>`
              : ""
          }
        </div>
      </div>
    `;

          ordersContainer.appendChild(orderCard);
        });
      }
      // Fetch orders from API
      async function fetchOrders() {
        try {
          if (!user || !user.user_id) {
            throw new Error("User not logged in");
          }

          showLoading();

          // Build query parameters
          const params = new URLSearchParams();
          params.append("user_id", user.user_id);
          if (statusFilter.value !== "all")
            params.append("status", statusFilter.value);
          if (dateFrom.value) params.append("from_date", dateFrom.value);
          if (dateTo.value) params.append("to_date", dateTo.value);

          const response = await fetch(
            `http://localhost:3000/orders?${params.toString()}`
          );

          if (!response.ok) {
            throw new Error("Failed to fetch orders");
          }

          const orders = await response.json();
          renderOrders(orders);
        } catch (error) {
          console.error("Error fetching orders:", error);
          showErrorState(error.message);
        }
      }

      // Order actions
      function reorder(orderId) {
        alert(`Reordering items from order #${orderId}`);
        // In a real implementation, this would add all items from the order to the cart
      }

      async function cancelOrder(orderId) {
        if (confirm("Are you sure you want to cancel this order?")) {
          try {
            const response = await fetch(
              `http://localhost:3000/orders/${orderId}`,
              {
                method: "DELETE",
              }
            );

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.message || "Failed to cancel order");
            }

            alert("Order cancelled successfully");
            fetchOrders(); // Refresh the list
          } catch (error) {
            console.error("Error cancelling order:", error);
            alert(error.message || "Failed to cancel order");
          }
        }
      }

      // Filter event listeners
      statusFilter.addEventListener("change", fetchOrders);
      dateFrom.addEventListener("change", fetchOrders);
      dateTo.addEventListener("change", fetchOrders);

      // Handle logout
      logoutLink.addEventListener("click", function (e) {
        e.preventDefault();
        fetch("http://localhost:3000/logout", {
          method: "POST",
          credentials: "same-origin",
        })
          .then(() => {
            localStorage.removeItem("isLoggedIn");
            localStorage.removeItem("user");
            window.location.href = "login.html";
          })
          .catch((err) => {
            console.error("Logout error:", err);
          });
      });

      // Initialize page
      document.addEventListener("DOMContentLoaded", () => {
        if (isLoggedIn && user) {
          // Set default date range (last 30 days)
          const today = new Date();
          const lastMonth = new Date();
          lastMonth.setMonth(lastMonth.getMonth() - 1);

          dateFrom.valueAsDate = lastMonth;
          dateTo.valueAsDate = today;

          fetchOrders();
        }
      });
    </script>
  </body>
</html>
