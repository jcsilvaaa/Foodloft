<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - FoodLoft</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Playfair+Display:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="admin.css" />
  </head>
  <body>
    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loading-spinner">
      <div class="spinner"></div>
      <p>Loading dashboard...</p>
    </div>

    <!-- Access Denied Message -->
    <div class="access-denied" id="access-denied">
      <div class="icon">üö´</div>
      <h2>Access Denied</h2>
      <p>You don't have permission to access this admin dashboard.</p>
      <a href="login.html" class="btn">Go to Login</a>
    </div>

    <!-- Main Dashboard Content -->
    <div id="dashboard-content" style="display: none">
      <header class="admin-header">
        <div class="admin-logo">
          <h1><a href="Homepage.html" class="logo-link">FoodLoftPH</a></h1>
          <span>Admin Dashboard</span>
        </div>
        <div class="admin-user">
          <img
            id="admin-avatar"
            src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face"
            alt="Admin"
          />
          <div class="admin-user-info">
            <span class="admin-username" id="admin-username">Admin User</span>
            <span class="admin-role" id="admin-role">Administrator</span>
          </div>
          <button class="logout-btn" id="logout-btn">Logout</button>
        </div>
      </header>

      <div class="dashboard-container">
        <nav class="sidebar">
          <ul class="sidebar-menu">
            <li>
              <a href="admin.html" class="active"
                ><span class="icon">üìä</span>Dashboard</a
              >
            </li>
            <li>
              <a href="order-management.html"
                ><span class="icon">üìã</span>Orders</a
              >
            </li>
            <li>
              <a href="menu-management.html"
                ><span class="icon">üçú</span>Menu Management</a
              >
            </li>
          </ul>
        </nav>

        <main class="main-content">
          <!-- Welcome Message -->
          <div class="welcome-message">
            <h3 id="welcome-text">Welcome back, Admin!</h3>
            <p>Here's your restaurant's performance overview</p>
          </div>

          <!-- Dashboard Content -->
          <div id="dashboard-content-inner" class="tab-content active">
            <div class="page-title">
              <h2>Dashboard Overview</h2>
              <p>Monitor your restaurant's key metrics and recent activity.</p>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
              <h3>Quick Actions</h3>
              <div class="actions-grid">
                <button
                  class="quick-action-btn"
                  onclick="redirectToPage('menu-management.html')"
                >
                  <span>‚ûï</span>Add New Dish
                </button>
                <button
                  class="quick-action-btn"
                  onclick="redirectToPage('order-management.html')"
                >
                  <span>üì¶</span>Process Orders
                </button>
              </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
              <div class="stat-card">
                <div class="icon orders">üìã</div>
                <h3 id="total-orders">-</h3>
                <p>Total Orders Today</p>
                <div class="change" id="orders-change">Loading...</div>
              </div>
              <div class="stat-card">
                <div class="icon revenue">üí∞</div>
                <h3 id="total-revenue">‚Ç±-</h3>
                <p>Today's Revenue</p>
                <div class="change" id="revenue-change">Loading...</div>
              </div>
              <div class="stat-card">
                <div class="icon customers">üë•</div>
                <h3 id="active-customers">-</h3>
                <p>Active Customers</p>
                <div class="change" id="customers-change">Loading...</div>
              </div>
              <div class="stat-card">
                <div class="icon dishes">üçú</div>
                <h3 id="menu-items">-</h3>
                <p>Menu Items</p>
                <div class="change" id="dishes-change">Loading...</div>
              </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
              <!-- Recent Orders -->
              <div class="chart-card">
                <h3>Recent Orders</h3>
                <div id="recent-orders-container">
                  <div class="loading-content">
                    <div class="mini-spinner"></div>
                    <span>Loading recent orders...</span>
                  </div>
                </div>
              </div>

              <!-- Popular Dishes -->
              <div class="chart-card">
                <h3>Popular Dishes</h3>
                <div id="popular-dishes-container">
                  <div class="loading-content">
                    <div class="mini-spinner"></div>
                    <span>Loading popular dishes...</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Recent Orders Table -->
            <div class="data-tables">
              <div class="table-card">
                <div class="table-header">
                  <h3>All Recent Orders</h3>
                  <button
                    class="view-all-btn"
                    onclick="redirectToPage('order-management.html')"
                  >
                    View All
                  </button>
                </div>
                <div id="orders-table-container">
                  <div class="loading-content">
                    <div class="mini-spinner"></div>
                    <span>Loading orders table...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script>
      // Global variables
      let dashboardData = {
        stats: {},
        recentOrders: [],
        popularDishes: [],
      };

      // Authentication and Access Control
      function checkAdminAccess() {
        const user = JSON.parse(localStorage.getItem("user"));

        // Show loading spinner initially
        document.getElementById("loading-spinner").style.display = "block";

        // Simulate checking process
        setTimeout(() => {
          document.getElementById("loading-spinner").style.display = "none";

          // Check if user exists and has admin role
          if (!user) {
            showAccessDenied();
            return false;
          }

          if (user.role !== "admin") {
            showAccessDenied();
            return false;
          }

          showDashboard(user);
          return true;
        }, 1000);
      }

      function showAccessDenied() {
        document.getElementById("access-denied").style.display = "block";
        document.getElementById("dashboard-content").style.display = "none";
      }

      function showDashboard(user) {
        document.getElementById("access-denied").style.display = "none";
        document.getElementById("dashboard-content").style.display = "block";

        // Update user information in header
        updateUserInfo(user);

        // Load dashboard data
        loadDashboardData();
      }

      function updateUserInfo(user) {
        const usernameElement = document.getElementById("admin-username");
        const welcomeElement = document.getElementById("welcome-text");
        const avatarElement = document.getElementById("admin-avatar");

        if (usernameElement && user.username) {
          usernameElement.textContent = user.username;
        }

        if (welcomeElement && user.username) {
          welcomeElement.textContent = `Welcome back, ${user.username}!`;
        }

        if (avatarElement && user.avatar) {
          avatarElement.src = `http://localhost:3000/uploads/${user.avatar}`;
          avatarElement.onerror = function () {
            this.src =
              "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face";
          };
        }
      }

      // API Functions
      async function fetchTodayStats() {
        try {
          const response = await fetch(
            "http://localhost:3000/admin/orders/stats/today"
          );
          if (!response.ok) throw new Error("Failed to fetch stats");
          return await response.json();
        } catch (error) {
          return null;
        }
      }

      async function fetchMenuStats() {
        try {
          const response = await fetch(
            "http://localhost:3000/admin/menu-stats"
          ); // Changed URL
          if (!response.ok) throw new Error("Failed to fetch menu stats");
          return await response.json();
        } catch (error) {
          console.error("Error fetching menu stats:", error);
          return {
            total_items: 0,
            available_items: 0,
            unavailable_items: 0,
            average_price: 0,
            highest_price: 0,
            lowest_price: 0,
          };
        }
      }
      async function fetchRecentOrders() {
        try {
          const response = await fetch("http://localhost:3000/admin/orders");
          if (!response.ok) throw new Error("Failed to fetch orders");
          const orders = await response.json();
          return orders.slice(0, 10); // Get latest 10 orders
        } catch (error) {
          return null;
        }
      }

      async function fetchPopularDishes() {
        try {
          // Get orders with their items to calculate popularity
          const response = await fetch("http://localhost:3000/admin/orders");
          if (!response.ok)
            throw new Error("Failed to fetch orders for popularity");

          const orders = await response.json();
          const dishCount = {};

          // Calculate dish popularity from recent orders
          for (const order of orders) {
            const orderDetails = await fetch(
              `http://localhost:3000/admin/orders/${order.order_id}`
            );
            if (orderDetails.ok) {
              const orderData = await orderDetails.json();
              for (const item of orderData.items) {
                if (dishCount[item.food_id]) {
                  dishCount[item.food_id].count += item.quantity;
                } else {
                  dishCount[item.food_id] = {
                    name: item.name,
                    count: item.quantity,
                    image: item.image,
                  };
                }
              }
            }
          }

          // Sort by popularity and get top 5
          const popularDishes = Object.entries(dishCount)
            .map(([id, data]) => ({ food_id: id, ...data }))
            .sort((a, b) => b.count - a.count)
            .slice(0, 5);

          return popularDishes;
        } catch (error) {
          return null;
        }
      }

      async function fetchUserCount() {
        try {
          const response = await fetch(
            "http://localhost:3000/admin/users/customers-count"
          );
          if (!response.ok) throw new Error("Failed to fetch customer count");
          const data = await response.json();
          return data.customers || 0;
        } catch (error) {
          return 0;
        }
      }

      // Dashboard Data Loading
      async function loadDashboardData() {
        try {
          // Load all data in parallel
          const [
            todayStats,
            menuStats,
            recentOrders,
            popularDishes,
            userCount,
          ] = await Promise.all([
            fetchTodayStats(),
            fetchMenuStats(),
            fetchRecentOrders(),
            fetchPopularDishes(),
            fetchUserCount(),
          ]);

          // Update stats cards
          updateStatsCards(todayStats, menuStats, userCount);

          // Update recent orders
          updateRecentOrders(recentOrders);

          // Update popular dishes
          updatePopularDishes(popularDishes);

          // Update orders table
          updateOrdersTable(recentOrders);
        } catch (error) {
          showError("Failed to load dashboard data");
        }
      }

      function updateStatsCards(todayStats, menuStats, userCount) {
        // Total Orders Today
        const totalOrders = todayStats?.total_orders || 0;
        document.getElementById("total-orders").textContent = totalOrders;
        document.getElementById(
          "orders-change"
        ).textContent = `${totalOrders} orders today`;
        document.getElementById("orders-change").className = "change positive";

        // Today's Revenue
        const totalRevenue = todayStats?.total_revenue || 0;
        document.getElementById(
          "total-revenue"
        ).textContent = `‚Ç±${totalRevenue.toLocaleString()}`;
        document.getElementById(
          "revenue-change"
        ).textContent = `‚Ç±${totalRevenue.toLocaleString()} today`;
        document.getElementById("revenue-change").className = "change positive";

        // Active Customers
        document.getElementById("active-customers").textContent =
          userCount.toLocaleString();
        document.getElementById(
          "customers-change"
        ).textContent = `${userCount} registered users`;
        document.getElementById("customers-change").className =
          "change positive";

        // Menu Items
        const menuItems = menuStats?.total_items || 0;
        const availableItems = menuStats?.available_items || 0;
        document.getElementById("menu-items").textContent = menuItems;
        document.getElementById(
          "dishes-change"
        ).textContent = `${availableItems} available`;
        document.getElementById("dishes-change").className =
          availableItems < menuItems ? "change negative" : "change positive";
      }

      function updateRecentOrders(orders) {
        const container = document.getElementById("recent-orders-container");

        if (!orders || orders.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üìã</div>
              <h4>No Recent Orders</h4>
              <p>No orders found for today.</p>
            </div>
          `;
          return;
        }

        const recentOrdersHTML = orders
          .slice(0, 5)
          .map(
            (order) => `
          <div class="dish-item">
            <div class="dish-rank">#${order.order_id}</div>
            <div class="dish-info">
              <div class="dish-name">${
                order.customer_name || "Unknown Customer"
              }</div>
              <div class="dish-stats">
                <span class="status-badge status-${order.status}">${
              order.status
            }</span>
                ‚Ä¢ ‚Ç±${parseFloat(order.total_price).toFixed(2)}
                ‚Ä¢ ${new Date(order.order_date).toLocaleTimeString()}
              </div>
            </div>
          </div>
        `
          )
          .join("");

        container.innerHTML = recentOrdersHTML;
      }

      function updatePopularDishes(dishes) {
        const container = document.getElementById("popular-dishes-container");

        if (!dishes || dishes.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üçΩÔ∏è</div>
              <h4>No Popular Dishes</h4>
              <p>No order data available to calculate popularity.</p>
            </div>
          `;
          return;
        }

        const popularDishesHTML = dishes
          .map(
            (dish, index) => `
          <div class="dish-item">
            <img 
              src="${
                dish.image
                  ? `http://localhost:3000/uploads/${dish.image}`
                  : "/Kikiam.jpg"
              }" 
              alt="${dish.name}" 
              class="dish-image"
              onerror="this.src='/Kikiam.jpg'"
            />
            <div class="dish-info">
              <div class="dish-name">${dish.name}</div>
              <div class="dish-stats">${dish.count} orders</div>
            </div>
            <div class="dish-rank">${index + 1}</div>
          </div>
        `
          )
          .join("");

        container.innerHTML = `<div class="popular-dishes-list">${popularDishesHTML}</div>`;
      }

      function updateOrdersTable(orders) {
        const container = document.getElementById("orders-table-container");

        if (!orders || orders.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üìã</div>
              <h4>No Orders Found</h4>
              <p>No orders available to display.</p>
            </div>
          `;
          return;
        }

        const tableHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Date</th>
                <th>Status</th>
                <th>Total</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${orders
                .slice(0, 10)
                .map(
                  (order) => `
                <tr>
                  <td>#${order.order_id}</td>
                  <td>${order.customer_name || "Unknown"}</td>
                  <td>${new Date(order.order_date).toLocaleDateString()}</td>
                  <td>
                    <span class="status-badge status-${order.status}">
                      ${
                        order.status.charAt(0).toUpperCase() +
                        order.status.slice(1)
                      }
                    </span>
                  </td>
                  <td>‚Ç±${parseFloat(order.total_price).toFixed(2)}</td>
                  <td>
                    <button class="action-btn" onclick="viewOrder(${
                      order.order_id
                    })">View</button>
                    <button class="action-btn secondary" onclick="updateOrderStatus(${
                      order.order_id
                    })">Update</button>
                  </td>
                </tr>
              `
                )
                .join("")}
            </tbody>
          </table>
        `;

        container.innerHTML = tableHTML;
      }

      function showError(message) {
        const containers = [
          "recent-orders-container",
          "popular-dishes-container",
          "orders-table-container",
        ];

        containers.forEach((id) => {
          const container = document.getElementById(id);
          if (container) {
            container.innerHTML = `
              <div class="error-message">
                <h4>Error</h4>
                <p>${message}</p>
                <button class="action-btn" onclick="loadDashboardData()">Try Again</button>
              </div>
            `;
          }
        });
      }

      // Navigation Functions
      function redirectToPage(page) {
        window.location.href = page;
      }

      function viewOrder(orderId) {
        window.location.href = `order-management.html?order=${orderId}`;
      }

      function updateOrderStatus(orderId) {
        window.location.href = `order-management.html?edit=${orderId}`;
      }

      // Logout Function
      function logout() {
        if (confirm("Are you sure you want to logout?")) {
          // Show loading
          const logoutBtn = document.getElementById("logout-btn");
          const originalText = logoutBtn.textContent;
          logoutBtn.textContent = "Logging out...";
          logoutBtn.disabled = true;

          // Clear localStorage first
          localStorage.removeItem("user");
          localStorage.removeItem("isLoggedIn");

          // Call logout endpoint
          fetch("http://localhost:3000/logout", {
            method: "POST",
            credentials: "same-origin",
          })
            .then((response) => response.json())
            .then((data) => {
              // Redirect to login page
              window.location.href = "login.html";
            })
            .catch((error) => {
              // Still redirect even if API call fails
              window.location.href = "login.html";
            })
            .finally(() => {
              // Reset button state (though page will redirect)
              logoutBtn.textContent = originalText;
              logoutBtn.disabled = false;
            });
        }
      }

      // Auto-refresh functionality
      function startAutoRefresh() {
        // Refresh dashboard data every 30 seconds
        setInterval(() => {
          loadDashboardData();
        }, 60000);
      }

      // Utility functions
      function formatCurrency(amount) {
        return new Intl.NumberFormat("en-PH", {
          style: "currency",
          currency: "PHP",
        }).format(amount);
      }

      function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString("en-PH", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // Event Listeners and Initialization
      document.addEventListener("DOMContentLoaded", function () {
        // Check admin access on page load
        checkAdminAccess();

        // Set up event listeners after DOM is loaded
        setTimeout(() => {
          // Logout button
          const logoutBtn = document.getElementById("logout-btn");
          if (logoutBtn) {
            logoutBtn.addEventListener("click", logout);
          }

          // Quick action buttons
          document.querySelectorAll(".quick-action-btn").forEach((btn) => {
            btn.addEventListener("click", function () {
              const text = this.textContent.trim();
              if (text.includes("Add New Dish")) {
                redirectToPage("menu-management.html");
              } else if (text.includes("Process Orders")) {
                redirectToPage("order-management.html");
              } else {
                alert(`${text} functionality would be implemented here!`);
              }
            });
          });

          // View all buttons
          document.querySelectorAll(".view-all-btn").forEach((btn) => {
            btn.addEventListener("click", function () {
              redirectToPage("order-management.html");
            });
          });

          // Start auto-refresh after initial load
          startAutoRefresh();
        }, 1100); // Wait for access check to complete
      });

      // Session management
      function checkSessionTimeout() {
        const user = JSON.parse(localStorage.getItem("user"));

        if (!user || user.role !== "admin") {
          localStorage.removeItem("user");
          localStorage.removeItem("isLoggedIn");
          window.location.href = "login.html";
        }
      }

      // Check session every 5 minutes
      setInterval(checkSessionTimeout, 5 * 60 * 1000);

      // Prevent back button after logout
      window.addEventListener("pageshow", function (event) {
        if (event.persisted) {
          // Page was loaded from cache (back button)
          // Only check if user is null (completely logged out)
          const user = JSON.parse(localStorage.getItem("user") || "null");
          if (!user) {
            window.location.href = "login.html";
          }
        }
      });

      // Handle browser back/forward navigation
      window.addEventListener("popstate", function (event) {
        // Only check if user is null (completely logged out)
        const user = JSON.parse(localStorage.getItem("user") || "null");
        if (!user) {
          window.location.href = "login.html";
        }
      });

      // Global error handler for admin-specific errors
      window.addEventListener("error", function (event) {
        console.error("Admin dashboard error:", event.error);
      });

      // Handle network errors gracefully
      window.addEventListener("online", function () {
        loadDashboardData();
      });

      window.addEventListener("offline", function () {
        showError("Network connection lost. Data may be outdated.");
      });
    </script>
  </body>
</html>
