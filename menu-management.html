<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FoodLoft - Menu</title>
  <link rel="stylesheet" href="menu-management.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet" />
</head>
<body>
  <header>
    <div class="logo">
      <h1><a href="Homepage.html" class="logo-link">FoodLoftPH</a></h1>
    </div>
    <nav>
      <ul>
        <li><a href="menu.html">Menu</a></li>
        <li><a href="cart.html">Cart (<span id="cart-count">0</span>)</a></li>
        <li class="user-menu">
          <img id="userAvatar" src="user.jpg" alt="User Profile" />
          <ul class="dropdown" id="user-dropdown">
            <li><a href="User.html">Profile</a></li>
            <li><a href="#" onclick="logout()">Log Out</a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </header>

  <body>
    <!-- Header -->
    <header class="admin-header">
      <div class="admin-logo">
        <h1><a href="Homepage.html" class="logo-link">FoodLoftPH</a></h1>
        <span>Admin Dashboard</span>
      </div>
      <div class="admin-user">
        <img
          id="admin-avatar"
          src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face"
          alt="Admin"
        />
        <div class="admin-user-info">
          <span class="admin-username" id="admin-username">Admin User</span>
          <span class="admin-role" id="admin-role">Administrator</span>
        </div>
        <button class="logout-btn" id="logout-btn">Logout</button>
      </div>
    </header>

    <div class="dashboard-container">
      <!-- Sidebar -->
      <nav class="sidebar">
        <ul class="sidebar-menu">
          <li>
            <a href="admin.html"><span class="icon">üìä</span>Dashboard</a>
          </li>
          <li>
            <a href="order-management.html"
              ><span class="icon">üìã</span>Orders</a
            >
          </li>
          <li>
            <a href="menu-management.html" class="active"
              ><span class="icon">üçú</span>Menu Management</a
            >
          </li>
        </ul>
      </nav>

      <!-- Main Content -->
      <main class="main-content">
        <div class="page-title">
          <h2>Menu Management</h2>
          <p>
            Add, edit, and organize your restaurant menu items and categories.
          </p>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
          <h3>Quick Actions</h3>
          <div class="actions-grid">
            <button class="quick-action-btn" onclick="openAddDishModal()">
              <span>‚ûï</span>Add New Dish
            </button>
            <button class="quick-action-btn" onclick="openCategoriesModal()">
              <span>üìÅ</span>Manage Categories
            </button>
          </div>
        </div>

        <!-- Menu Categories Stats -->
        <div class="stats-grid" id="category-stats">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading statistics...</p>
          </div>
        </div>

        <!-- Menu Filters -->
        <div class="filter-card">
          <div class="filter-group">
            <label for="category-filter">Category:</label>
            <select id="category-filter">
              <option value="">All Categories</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="status-filter">Status:</label>
            <select id="status-filter">
              <option value="">All Status</option>
              <option value="1">Available</option>
              <option value="0">Unavailable</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="price-range">Price Range:</label>
            <select id="price-range">
              <option value="">All Prices</option>
              <option value="0-300">‚Ç±0 - ‚Ç±300</option>
              <option value="300-600">‚Ç±300 - ‚Ç±600</option>
              <option value="600-1000">‚Ç±600 - ‚Ç±1,000</option>
              <option value="1000+">‚Ç±1,000+</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="search-dish">Search Dish:</label>
            <input
              type="text"
              id="search-dish"
              placeholder="Enter dish name..."
            />
          </div>
          <button class="action-btn" onclick="applyFilters()">
            Apply Filters
          </button>
          <button class="action-btn secondary" onclick="clearFilters()">
            Clear
          </button>
        </div>

        <!-- Menu Items Table -->
        <div class="table-card">
          <div class="table-header">
            <h3 id="menu-count">Menu Items (0 total)</h3>
            <div>
              <button class="action-btn secondary" onclick="refreshMenu()">
                Refresh
              </button>
              <button class="action-btn" onclick="openAddDishModal()">
                Add New Dish
              </button>
            </div>
          </div>
          <div id="menu-table-container">
            <div class="loading">
              <div class="spinner"></div>
              <p>Loading menu items...</p>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Add/Edit Dish Modal -->
    <div id="dishModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">Add New Dish</h3>
          <span class="close" onclick="closeDishModal()">&times;</span>
        </div>
        <form id="dishForm" enctype="multipart/form-data">
          <input type="hidden" id="dishId" name="dishId" />

          <div class="form-group">
            <label for="dishName">Dish Name</label>
            <input type="text" id="dishName" name="name" required />
          </div>

          <div class="form-group">
            <label for="dishDescription">Description</label>
            <textarea
              id="dishDescription"
              name="description"
              placeholder="Brief description of the dish..."
            ></textarea>
          </div>

          <div class="form-group">
            <label for="dishCategory">Category</label>
            <select id="dishCategory" name="category_id" required>
              <option value="">Select Category</option>
            </select>
          </div>

          <div class="form-group">
            <label for="dishPrice">Price</label>
            <div class="price-input">
              <input
                type="number"
                id="dishPrice"
                name="price"
                min="0"
                step="0.01"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label for="dishImage">Dish Image</label>
            <input type="file" id="dishImage" name="image" accept="image/*" />
            <div id="current-image" style="margin-top: 10px; display: none">
              <small>Current image:</small><br />
              <img
                id="current-image-preview"
                src=""
                alt="Current dish image"
                style="
                  max-width: 100px;
                  height: auto;
                  border-radius: 4px;
                  margin-top: 5px;
                "
              />
            </div>
          </div>

          <div class="form-group">
            <label for="dishStatus">Status</label>
            <select id="dishStatus" name="is_available" required>
              <option value="1">Available</option>
              <option value="0">Unavailable</option>
            </select>
          </div>

          <div style="text-align: center; margin-top: 30px">
            <button type="submit" class="action-btn" style="margin-right: 10px">
              Save Dish
            </button>
            <button
              type="button"
              class="action-btn secondary"
              onclick="closeDishModal()"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Categories Management Modal -->
    <div id="categoriesModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Manage Categories</h3>
          <span class="close" onclick="closeCategoriesModal()">&times;</span>
        </div>
        
        <!-- Add New Category Form -->
        <div class="form-group">
          <label for="newCategoryName">Add New Category</label>
          <div style="display: flex; gap: 10px;">
            <input 
              type="text" 
              id="newCategoryName" 
              placeholder="Enter category name..."
              style="flex: 1;"
            />
            <button class="action-btn" onclick="addNewCategory()">Add</button>
          </div>
        </div>

        <!-- Categories List -->
        <div style="margin-top: 30px;">
          <h4 style="margin-bottom: 15px; color: #8b0000;">Existing Categories</h4>
          <div id="categories-list">
            <div class="loading">
              <div class="spinner"></div>
              <p>Loading categories...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bulk Price Update Modal -->
    <div id="bulkPriceModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Bulk Price Update</h3>
          <span class="close" onclick="closeBulkPriceModal()">&times;</span>
        </div>

        <!-- Selection Criteria -->
        <div class="bulk-price-section">
          <h4>Select Items to Update</h4>
          <div class="form-group">
            <label for="bulk-category">Filter by Category (optional):</label>
            <select id="bulk-category">
              <option value="">All Categories</option>
            </select>
          </div>
          <button class="action-btn secondary" onclick="loadItemsForBulkUpdate()">
            Load Items
          </button>
        </div>

        <!-- Selected Items Display -->
        <div id="selected-items-display" style="display: none;">
          <div class="selected-items">
            <h4>Selected Items</h4>
            <p><span class="selected-count" id="selected-count">0</span> items selected</p>
            <div id="selected-items-list" style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
              <!-- Items will be listed here -->
            </div>
          </div>

          <!-- Price Update Options -->
          <div class="bulk-price-section">
            <h4>Price Update Method</h4>
            <div class="bulk-price-options">
              <label>
                <input type="radio" name="priceMethod" value="percentage" checked />
                Percentage Change
              </label>
              <label>
                <input type="radio" name="priceMethod" value="fixed" />
                Fixed Amount Change
              </label>
              <label>
                <input type="radio" name="priceMethod" value="set" />
                Set New Price
              </label>
            </div>

            <div id="percentage-controls" class="percentage-input-group">
              <label>
                <input type="radio" name="percentageType" value="increase" checked />
                Increase by
              </label>
              <label>
                <input type="radio" name="percentageType" value="decrease" />
                Decrease by
              </label>
              <input type="number" id="percentage-value" min="0" step="0.1" placeholder="10" />
              <span>%</span>
            </div>

            <div id="fixed-controls" class="percentage-input-group" style="display: none;">
              <label>
                <input type="radio" name="fixedType" value="increase" checked />
                Increase by
              </label>
              <label>
                <input type="radio" name="fixedType" value="decrease" />
                Decrease by
              </label>
              <div class="price-input" style="width: 150px;">
                <input type="number" id="fixed-value" min="0" step="0.01" placeholder="50.00" />
              </div>
            </div>

            <div id="set-controls" class="percentage-input-group" style="display: none;">
              <span>Set all selected items to:</span>
              <div class="price-input" style="width: 150px;">
                <input type="number" id="set-value" min="0" step="0.01" placeholder="299.00" />
              </div>
            </div>
          </div>

          <!-- Preview and Apply -->
          <div style="text-align: center; margin-top: 30px;">
            <button class="action-btn secondary" onclick="previewPriceChanges()" style="margin-right: 10px;">
              Preview Changes
            </button>
            <button class="action-btn" onclick="applyBulkPriceUpdate()" style="margin-right: 10px;">
              Apply Changes
            </button>
            <button class="action-btn secondary" onclick="closeBulkPriceModal()">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentMenuItems = [];
      let currentCategories = [];
      let currentFilters = {};
      let isEditMode = false;
      let selectedItemsForBulkUpdate = [];

      // Authentication check
      function checkAdminAccess() {
        const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";
        const user = JSON.parse(localStorage.getItem("user"));

        if (!isLoggedIn || !user || user.role !== "admin") {
          window.location.href = "login.html";
          return false;
        }

        updateUserInfo(user);
        return true;
      }

      function updateUserInfo(user) {
        const usernameElement = document.getElementById("admin-username");
        const avatarElement = document.getElementById("admin-avatar");

        if (usernameElement && user.username) {
          usernameElement.textContent = user.username;
        }

        if (avatarElement && user.avatar) {
          avatarElement.src = `http://localhost:3000/uploads/${user.avatar}`;
          avatarElement.onerror = function () {
            this.src =
              "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face";
          };
        }
      }

      // Logout function
      function logout() {
        if (confirm("Are you sure you want to logout?")) {
          localStorage.removeItem("user");
          localStorage.removeItem("isLoggedIn");

          fetch("http://localhost:3000/logout", {
            method: "POST",
            credentials: "same-origin",
          })
            .then(() => {
              window.location.href = "login.html";
            })
            .catch(() => {
              window.location.href = "login.html";
            });
        }
      }

      // Fetch categories from backend
      async function fetchCategories() {
        try {
          const response = await fetch(
            "http://localhost:3000/admin/categories"
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const categories = await response.json();
          currentCategories = categories;
          populateCategoryOptions(categories);
        } catch (error) {
          console.error("Error fetching categories:", error);
        }
      }

      // Populate category dropdowns
      function populateCategoryOptions(categories) {
        const filterSelect = document.getElementById("category-filter");
        const modalSelect = document.getElementById("dishCategory");
        const bulkSelect = document.getElementById("bulk-category");

        // Clear existing options (except "All Categories" for filter)
        filterSelect.innerHTML = '<option value="">All Categories</option>';
        modalSelect.innerHTML = '<option value="">Select Category</option>';
        bulkSelect.innerHTML = '<option value="">All Categories</option>';

        categories.forEach((category) => {
          const filterOption = new Option(category.name, category.category_id);
          const modalOption = new Option(category.name, category.category_id);
          const bulkOption = new Option(category.name, category.category_id);

          filterSelect.appendChild(filterOption);
          modalSelect.appendChild(modalOption);
          bulkSelect.appendChild(bulkOption);
        });
      }

      // Fetch menu items from backend
      async function fetchMenuItems(filters = {}) {
        try {
          showMenuLoading();

          const queryParams = new URLSearchParams();
          if (filters.category_id)
            queryParams.append("category_id", filters.category_id);
          if (filters.is_available !== undefined)
            queryParams.append("is_available", filters.is_available);
          if (filters.priceRange)
            queryParams.append("price_range", filters.priceRange);
          if (filters.search) queryParams.append("search", filters.search);

          const response = await fetch(
            `http://localhost:3000/admin/menu?${queryParams}`
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const menuItems = await response.json();
          currentMenuItems = menuItems;
          renderMenuItems(menuItems);
          updateCategoryStats();
        } catch (error) {
          console.error("Error fetching menu items:", error);
          showMenuError("Failed to load menu items. Please try again.");
        }
      }

      // Render menu items table
      function renderMenuItems(menuItems) {
        const container = document.getElementById("menu-table-container");
        const menuCount = document.getElementById("menu-count");

        menuCount.textContent = `Menu Items (${menuItems.length} total)`;

        if (menuItems.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üçΩÔ∏è</div>
              <h3>No Menu Items Found</h3>
              <p>No items match the current filters.</p>
            </div>
          `;
          return;
        }

        const tableHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>Image</th>
                <th>Dish Name</th>
                <th>Category</th>
                <th>Price</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${menuItems
                .map(
                  (item) => `
                <tr>
                  <td>
                    <img
                      src="${
                        item.image
                          ? `http://localhost:3000/uploads/${item.image}`
                          : "/Kikiam.jpg"
                      }"
                      class="dish-thumb"
                      alt="${item.name}"
                      onerror="this.src='/Kikiam.jpg'"
                    />
                  </td>
                  <td>
                    <strong>${item.name}</strong><br />
                    <small style="color: #666">${
                      item.description || "No description"
                    }</small>
                  </td>
                  <td>${item.category_name || "Unknown"}</td>
                  <td>‚Ç±${parseFloat(item.price).toFixed(2)}</td>
                  <td>
                    <span class="status-badge status-${item.is_available}">
                      ${item.is_available ? "Available" : "Unavailable"}
                    </span>
                  </td>
                  <td>
                    <button class="action-btn secondary" onclick="editDish(${
                      item.food_id
                    })">Edit</button>
                    <button class="action-btn ${
                      item.is_available ? "danger" : "success"
                    }" 
                            onclick="toggleAvailability(${item.food_id}, ${
                    item.is_available
                  })">
                      ${item.is_available ? "Disable" : "Enable"}
                    </button>
                  </td>
                </tr>
              `
                )
                .join("")}
            </tbody>
          </table>
        `;

        container.innerHTML = tableHTML;
      }

      // Update category statistics
      function updateCategoryStats() {
        const statsContainer = document.getElementById("category-stats");

        if (currentCategories.length === 0) {
          statsContainer.innerHTML = `
            <div class="loading">
              <div class="spinner"></div>
              <p>Loading statistics...</p>
            </div>
          `;
          return;
        }

        const categoryStats = currentCategories.map((category) => {
          const count = currentMenuItems.filter(
            (item) => item.category_id === category.category_id
          ).length;
          return {
            ...category,
            count,
          };
        });

        const statsHTML = categoryStats
          .map(
            (category) => `
          <div class="stat-card">
            <div class="icon">${getCategoryIcon(category.name)}</div>
            <h3>${category.count}</h3>
            <p>${category.name} Dishes</p>
          </div>
        `
          )
          .join("");

        statsContainer.innerHTML = statsHTML;
      }

      // Get category icon based on name
      function getCategoryIcon(categoryName) {
        const icons = {
          sichuan: "üå∂Ô∏è",
          cantonese: "ü•ü",
          beijing: "ü¶Ü",
          shanghai: "üçú",
          fujian: "ü•¢",
          appetizers: "ü•ó",
          "main course": "üçΩÔ∏è",
          desserts: "üç∞",
          beverages: "ü•§",
        };

        const lowerName = categoryName.toLowerCase();
        return icons[lowerName] || "üçΩÔ∏è";
      }

      // Modal functions
      function openAddDishModal() {
        isEditMode = false;
        document.getElementById("modalTitle").textContent = "Add New Dish";
        document.getElementById("dishForm").reset();
        document.getElementById("dishId").value = "";
        document.getElementById("current-image").style.display = "none";
        document.getElementById("dishModal").style.display = "block";
      }

      async function editDish(foodId) {
        try {
          isEditMode = true;
          const response = await fetch(
            `http://localhost:3000/admin/menu/${foodId}`
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const dish = await response.json();

          document.getElementById("modalTitle").textContent = "Edit Dish";
          document.getElementById("dishId").value = dish.food_id;
          document.getElementById("dishName").value = dish.name;
          document.getElementById("dishDescription").value =
            dish.description || "";
          document.getElementById("dishCategory").value = dish.category_id;
          document.getElementById("dishPrice").value = dish.price;
          document.getElementById("dishStatus").value = dish.is_available;

          // Show current image if exists
          if (dish.image) {
            document.getElementById("current-image").style.display = "block";
            document.getElementById(
              "current-image-preview"
            ).src = `http://localhost:3000/uploads/${dish.image}`;
          } else {
            document.getElementById("current-image").style.display = "none";
          }

          document.getElementById("dishModal").style.display = "block";
        } catch (error) {
          console.error("Error fetching dish details:", error);
          alert("Failed to load dish details. Please try again.");
        }
      }

      function closeDishModal() {
        document.getElementById("dishModal").style.display = "none";
        isEditMode = false;
      }

      // Categories Modal Functions
      function openCategoriesModal() {
        document.getElementById("categoriesModal").style.display = "block";
        loadCategoriesList();
      }

      function closeCategoriesModal() {
        document.getElementById("categoriesModal").style.display = "none";
      }

      async function loadCategoriesList() {
        const container = document.getElementById("categories-list");
        
        try {
          container.innerHTML = `
            <div class="loading">
              <div class="spinner"></div>
              <p>Loading categories...</p>
            </div>
          `;

          await fetchCategories(); // Refresh categories data

          if (currentCategories.length === 0) {
            container.innerHTML = `
              <div class="empty-state">
                <div class="icon">üìÅ</div>
                <h4>No Categories Found</h4>
                <p>Add your first category using the form above.</p>
              </div>
            `;
            return;
          }

          const categoriesHTML = currentCategories
            .map(
              (category) => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 10px;">
                <div>
                  <strong>${category.name}</strong>
                  <br />
                  <small style="color: #666;">Category ID: ${category.category_id}</small>
                </div>
                <div>
                  <button class="action-btn secondary" onclick="editCategory(${category.category_id}, '${category.name}')" style="margin-right: 10px;">
                    Edit
                  </button>
                  <button class="action-btn danger" onclick="deleteCategory(${category.category_id}, '${category.name}')">
                    Delete
                  </button>
                </div>
              </div>
            `
            )
            .join("");

          container.innerHTML = categoriesHTML;
        } catch (error) {
          container.innerHTML = `
            <div class="error-message">
              <h4>Error</h4>
              <p>Failed to load categories. Please try again.</p>
            </div>
          `;
        }
      }

      async function addNewCategory() {
        const nameInput = document.getElementById("newCategoryName");
        const name = nameInput.value.trim();

        if (!name) {
          alert("Please enter a category name.");
          return;
        }

        try {
          const response = await fetch("http://localhost:3000/admin/categories", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ name }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          alert("Category added successfully!");
          nameInput.value = "";
          loadCategoriesList();
          fetchCategories(); // Refresh dropdown options
        } catch (error) {
          console.error("Error adding category:", error);
          alert("Failed to add category. Please try again.");
        }
      }

      async function editCategory(categoryId, currentName) {
        const newName = prompt("Enter new category name:", currentName);
        
        if (!newName || newName.trim() === "") {
          return;
        }

        if (newName.trim() === currentName) {
          return; // No change
        }

        try {
          const response = await fetch(`http://localhost:3000/admin/categories/${categoryId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ name: newName.trim() }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          alert("Category updated successfully!");
          loadCategoriesList();
          fetchCategories(); // Refresh dropdown options
        } catch (error) {
          console.error("Error updating category:", error);
          alert("Failed to update category. Please try again.");
        }
      }

      async function deleteCategory(categoryId, categoryName) {
        if (!confirm(`Are you sure you want to delete the category "${categoryName}"?\n\nThis action cannot be undone. Make sure no menu items are using this category.`)) {
          return;
        }

        try {
          const response = await fetch(`http://localhost:3000/admin/categories/${categoryId}`, {
            method: "DELETE",
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
          }

          alert("Category deleted successfully!");
          loadCategoriesList();
          fetchCategories(); // Refresh dropdown options
        } catch (error) {
          console.error("Error deleting category:", error);
          alert(`Failed to delete category: ${error.message}`);
        }
      }

      function setupPriceMethodHandlers() {
        const methodRadios = document.querySelectorAll('input[name="priceMethod"]');
        
        methodRadios.forEach(radio => {
          radio.addEventListener('change', function() {
            // Hide all controls
            document.getElementById('percentage-controls').style.display = 'none';
            document.getElementById('fixed-controls').style.display = 'none';
            document.getElementById('set-controls').style.display = 'none';
            
            // Show relevant controls
            if (this.value === 'percentage') {
              document.getElementById('percentage-controls').style.display = 'flex';
            } else if (this.value === 'fixed') {
              document.getElementById('fixed-controls').style.display = 'flex';
            } else if (this.value === 'set') {
              document.getElementById('set-controls').style.display = 'flex';
            }
          });
        });
      }

      async function loadItemsForBulkUpdate() {
        const categoryFilter = document.getElementById("bulk-category").value;
        
        try {
          // Use current menu items or fetch with category filter
          let itemsToShow = currentMenuItems;
          
          if (categoryFilter) {
            itemsToShow = currentMenuItems.filter(item => 
              item.category_id == categoryFilter
            );
          }

          if (itemsToShow.length === 0) {
            alert("No items found for the selected criteria.");
            return;
          }

          selectedItemsForBulkUpdate = [...itemsToShow];
          displaySelectedItems();
          document.getElementById("selected-items-display").style.display = "block";
        } catch (error) {
          console.error("Error loading items for bulk update:", error);
          alert("Failed to load items. Please try again.");
        }
      }

      function displaySelectedItems() {
        const countElement = document.getElementById("selected-count");
        const listElement = document.getElementById("selected-items-list");
        
        countElement.textContent = selectedItemsForBulkUpdate.length;
        
        const itemsHTML = selectedItemsForBulkUpdate
          .map(item => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
              <div>
                <strong>${item.name}</strong> - ‚Ç±${parseFloat(item.price).toFixed(2)}
                <br />
                <small style="color: #666;">${item.category_name || 'Unknown Category'}</small>
              </div>
              <button class="action-btn danger" onclick="removeFromBulkUpdate(${item.food_id})" style="padding: 4px 8px; font-size: 0.8rem;">
                Remove
              </button>
            </div>
          `)
          .join("");
          
        listElement.innerHTML = itemsHTML;
      }

      function removeFromBulkUpdate(foodId) {
        selectedItemsForBulkUpdate = selectedItemsForBulkUpdate.filter(item => 
          item.food_id !== foodId
        );
        
        if (selectedItemsForBulkUpdate.length === 0) {
          document.getElementById("selected-items-display").style.display = "none";
        } else {
          displaySelectedItems();
        }
      }

      function previewPriceChanges() {
        const changes = calculatePriceChanges();
        
        if (!changes) return;
        
        let previewText = "Price Change Preview:\n\n";
        
        changes.forEach(change => {
          previewText += `${change.name}\n`;
          previewText += `  Current: ‚Ç±${change.currentPrice.toFixed(2)}\n`;
          previewText += `  New: ‚Ç±${change.newPrice.toFixed(2)}\n`;
          previewText += `  Change: ${change.newPrice > change.currentPrice ? '+' : ''}‚Ç±${(change.newPrice - change.currentPrice).toFixed(2)}\n\n`;
        });
        
        alert(previewText);
      }

      function calculatePriceChanges() {
        const method = document.querySelector('input[name="priceMethod"]:checked').value;
        const changes = [];
        
        selectedItemsForBulkUpdate.forEach(item => {
          const currentPrice = parseFloat(item.price);
          let newPrice = currentPrice;
          
          if (method === 'percentage') {
            const percentageValue = parseFloat(document.getElementById('percentage-value').value || 0);
            const isIncrease = document.querySelector('input[name="percentageType"]:checked').value === 'increase';
            
            if (isIncrease) {
              newPrice = currentPrice * (1 + percentageValue / 100);
            } else {
              newPrice = currentPrice * (1 - percentageValue / 100);
            }
          } else if (method === 'fixed') {
            const fixedValue = parseFloat(document.getElementById('fixed-value').value || 0);
            const isIncrease = document.querySelector('input[name="fixedType"]:checked').value === 'increase';
            
            if (isIncrease) {
              newPrice = currentPrice + fixedValue;
            } else {
              newPrice = currentPrice - fixedValue;
            }
          } else if (method === 'set') {
            newPrice = parseFloat(document.getElementById('set-value').value || 0);
          }
          
          // Ensure price doesn't go below 0
          newPrice = Math.max(0, newPrice);
          
          changes.push({
            food_id: item.food_id,
            name: item.name,
            currentPrice,
            newPrice
          });
        });
        
        return changes;
      }

      async function applyBulkPriceUpdate() {
        const changes = calculatePriceChanges();
        
        if (!changes || changes.length === 0) {
          alert("No items selected or no valid price changes calculated.");
          return;
        }
        
        // Validate inputs
        const method = document.querySelector('input[name="priceMethod"]:checked').value;
        let inputValue = 0;
        
        if (method === 'percentage') {
          inputValue = parseFloat(document.getElementById('percentage-value').value || 0);
        } else if (method === 'fixed') {
          inputValue = parseFloat(document.getElementById('fixed-value').value || 0);
        } else if (method === 'set') {
          inputValue = parseFloat(document.getElementById('set-value').value || 0);
        }
        
        if (inputValue <= 0 && method !== 'set') {
          alert("Please enter a valid value for the price update.");
          return;
        }
        
        if (method === 'set' && inputValue < 0) {
          alert("Price cannot be negative.");
          return;
        }
        
        if (!confirm(`Are you sure you want to update prices for ${changes.length} items?`)) {
          return;
        }
        
        try {
          // Prepare data for bulk update
          const bulkUpdateData = {
            items: changes.map(change => ({
              food_id: change.food_id,
              price: change.newPrice
            }))
          };

          const response = await fetch("http://localhost:3000/admin/menu/bulk-price-update", {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(bulkUpdateData),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          alert(`Successfully updated prices for ${result.updated_count} items!`);
          closeBulkPriceModal();
          fetchMenuItems(currentFilters); // Refresh the menu items display
        } catch (error) {
          console.error("Error applying bulk price update:", error);
          alert(`Failed to update prices: ${error.message}`);
        }
      }

      // Form submission
      async function submitDishForm(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const submitButton = event.target.querySelector(
          'button[type="submit"]'
        );
        const originalText = submitButton.textContent;

        try {
          submitButton.textContent = "Saving...";
          submitButton.disabled = true;

          const url = isEditMode
            ? `http://localhost:3000/admin/menu/${formData.get("dishId")}`
            : "http://localhost:3000/admin/menu";

          const method = isEditMode ? "PUT" : "POST";

          const response = await fetch(url, {
            method: method,
            body: formData,
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          alert(
            isEditMode
              ? "Dish updated successfully!"
              : "Dish added successfully!"
          );
          closeDishModal();
          fetchMenuItems(currentFilters);
        } catch (error) {
          console.error("Error saving dish:", error);
          alert("Failed to save dish. Please try again.");
        } finally {
          submitButton.textContent = originalText;
          submitButton.disabled = false;
        }
      }

      // Toggle dish availability
      async function toggleAvailability(foodId, currentStatus) {
        const newStatus = currentStatus ? 0 : 1;
        const action = newStatus ? "enable" : "disable";

        if (!confirm(`Are you sure you want to ${action} this dish?`)) {
          return;
        }

        try {
          const response = await fetch(
            `http://localhost:3000/admin/menu/${foodId}/availability`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ is_available: newStatus }),
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          alert(`Dish ${action}d successfully!`);
          fetchMenuItems(currentFilters);
        } catch (error) {
          console.error("Error updating dish availability:", error);
          alert("Failed to update dish status. Please try again.");
        }
      }

      // Filter functions
      function applyFilters() {
        const filters = {
          category_id: document.getElementById("category-filter").value,
          is_available: document.getElementById("status-filter").value,
          priceRange: document.getElementById("price-range").value,
          search: document.getElementById("search-dish").value.trim(),
        };

        // Remove empty values
        Object.keys(filters).forEach((key) => {
          if (filters[key] === "" || filters[key] === undefined) {
            delete filters[key];
          }
        });

        currentFilters = filters;
        fetchMenuItems(filters);
      }

      function clearFilters() {
        document.getElementById("category-filter").value = "";
        document.getElementById("status-filter").value = "";
        document.getElementById("price-range").value = "";
        document.getElementById("search-dish").value = "";

        currentFilters = {};
        fetchMenuItems();
      }

      function refreshMenu() {
        fetchMenuItems(currentFilters);
      }

      // Utility functions
      function showMenuLoading() {
        const container = document.getElementById("menu-table-container");
        container.innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading menu items...</p>
          </div>
        `;
      }

      function showMenuError(message) {
        const container = document.getElementById("menu-table-container");
        container.innerHTML = `
          <div class="error-message">
            <h4>Error</h4>
            <p>${message}</p>
            <button class="action-btn" onclick="fetchMenuItems(currentFilters)" style="margin-top: 10px;">Try Again</button>
          </div>
        `;
      }

      // Event listeners
      document.addEventListener("DOMContentLoaded", function () {
        // Check admin access
        if (!checkAdminAccess()) return;

        // Set up event listeners
        document.getElementById("logout-btn").addEventListener("click", logout);
        document
          .getElementById("dishForm")
          .addEventListener("submit", submitDishForm);

        // Close modals when clicking outside
        window.addEventListener("click", function (event) {
          const dishModal = document.getElementById("dishModal");
          const categoriesModal = document.getElementById("categoriesModal");
          const bulkPriceModal = document.getElementById("bulkPriceModal");
          
          if (event.target === dishModal) {
            closeDishModal();
          }
          if (event.target === categoriesModal) {
            closeCategoriesModal();
          }
          if (event.target === bulkPriceModal) {
            closeBulkPriceModal();
          }
        });

        // Handle filter changes
        document
          .getElementById("category-filter")
          .addEventListener("change", function () {
            if (this.value === "") return; // Don't auto-apply for "All Categories"
            applyFilters();
          });

        document
          .getElementById("status-filter")
          .addEventListener("change", function () {
            if (this.value === "") return; // Don't auto-apply for "All Status"
            applyFilters();
          });

        // Handle Enter key in search input
        document
          .getElementById("search-dish")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              applyFilters();
            }
          });

        // Handle Enter key in new category input
        document
          .getElementById("newCategoryName")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              addNewCategory();
            }
          });

        // Load initial data
        fetchCategories();
        fetchMenuItems();

        // Auto-refresh every 60 seconds
        setInterval(() => {
          fetchMenuItems(currentFilters);
        }, 60000);
      });

      // Prevent back button after logout
      window.addEventListener("pageshow", function (event) {
        if (event.persisted) {
          checkAdminAccess();
        }
      });
    </script>
  </body>
</html>
